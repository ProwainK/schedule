<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Summer Games Done Quick 2025 時程表翻譯 ლ(╹◡╹ლ)</title>

 <link href="https://fonts.googleapis.com/css2?family=Klee+One&display=swap" rel="stylesheet">
<link href="https://unpkg.com/embla-carousel/embla-carousel.css" rel="stylesheet" />
<style>
  body {
    margin: 0;
    /* font-family: Arial, sans-serif; */
    /* Klee One, Kaisei Opti, Zen Kurenaido, Zen Maru Gothic */
    font-family: 'Klee One', monospace;
    color: white;

  user-select: none;

  text-shadow: black 0.2em 0.2em 0.3em;

  background-image: linear-gradient(to right, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0.3)),
                    url(https://gamesdonequick.com/gdqsection.webp);
  background-color: #222;
  background-repeat: no-repeat;
  background-size: cover;
  background-attachment: fixed;
  }
  .day-selector {
    display: flex;
    background: rgba(0, 0, 0, 0.2);
    overflow-x: auto;
  }
  .day-button {
    flex: 1 0 auto;
    background: rgba(0, 0, 0, 0.2);
    border: none;
    color: white;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    cursor: pointer;
    white-space: nowrap;
    transition: background-color 0.3s;

    text-shadow: black 0.2em 0.2em 0.3em;
  }
  .day-button.active {
    /* background: #6441a5; */
    background: rgba(100, 65, 165, 0.85);
  }

  /* 主輪播 */
  #embla {
    overflow: hidden;
    width: 100%;
    height: 80vh;
  }
  #embla .embla__container {
    display: flex;
    height: 100%;
  }
  #embla .embla__slide {
    min-width: 100%;
    box-sizing: border-box;
    display: flex;
    padding: 1rem;
    gap: 1rem;
    border-radius: 20px;
  }
  .left-side {
    width: 40%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
  }
  .right-side {
    /* align-items: center; */
    /* container-type: inline-size; */
    white-space: nowrap; /* 絕對不換行 */
  }
  .right-side h2 {
    margin: 0 0 10px;
    /* font-size: 7cqi; */
    font-size: 3.5rem;
    color: #FFF;
  }
  .game-boxart {
    /* width: 100%; */
    /* height: 70vh; */
    max-height: 70vh;
    max-width: 25vw;
    border-radius: 10px;
    /* object-fit: cover; */

/* align-items: center; */
/* justify-content: center; */
  }
  .right-side {
    width: 55%;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    color: #ccc;
    justify-content: center;
  }
  .right-side h3 {
    margin: 0;
    font-weight: normal;
    font-size: 2.25rem;
  }
  .category-tw {
    color: #9894F9;
    font-weight: bold;
    font-size: 1.75rem;
    margin: 0.25rem 0;
  }
  .details {
    color: #f08080;
    font-size: 1.5rem;
    margin: 0;
  }
  p {
    margin: 0.25rem 0;
    font-size: 1rem;
  }

  /* 縮圖輪播 */
  #thumbnailList {
    overflow: hidden;
    /* margin-top: 0.5rem; */
    background: rgba(0, 0, 0, 0.3);
  }
  #thumbnailList .embla__container {
    display: flex;
    padding: 0.5rem;
  }
  #thumbnailList .embla__slide {
    flex: 0 0 auto;
    margin-right: 0.5rem;
  }
  .thumbnail {
    width: 80px;
    height: 80px;
    border-radius: 6px;
    object-fit: cover;
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.3s;
  }
  .thumbnail.is-selected {
    border-color: #FFF;
  }

/* Loading 樣式 */
#loadingOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  z-index: 9999;
  text-shadow: black 0.1em 0.1em 0.2em;
}
</style>
</head>
<body>

<div id="loadingOverlay">載入中，請稍候…</div>

<div class="day-selector" id="daySelector"></div>

<div id="embla" class="embla">
  <div class="embla__container" id="scheduleList"></div>
</div>

<div id="thumbnailList" class="embla">
  <div class="embla__container" id="thumbnailContainer"></div>
</div>

<script src="https://unpkg.com/embla-carousel/embla-carousel.umd.js"></script>
<script src="https://unpkg.com/embla-carousel-wheel-gestures/dist/embla-carousel-wheel-gestures.umd.js"></script>
<script src="gameDB.js"></script>
<script>
  // 顯示 loading
  const loadingEl = document.getElementById('loadingOverlay');
  if (loadingEl) loadingEl.style.display = 'flex';

  const EVENT_ID = 56;
  let allRuns = [];
  let embla, thumbEmbla;

  async function init() {
    try {
      // const res = await fetch(`https://gamesdonequick.com/api/schedule/${EVENT_ID}`);
      const res = await fetch(`https://tracker.gamesdonequick.com/tracker/api/v2/events/${EVENT_ID}/runs`);
      const json = await res.json();
      // allRuns = json.schedule
      allRuns = json.results
        .filter(r => r.type === 'speedrun')
        .map(r => ({
          game: r.name,
          category: r.category,
          runners: r.runners.map(rr => rr.name).join(', '),
          start: new Date(r.starttime),
          estimate: r.run_time,
        }));

      createDayButtons();
      const firstDate = getUniqueDates()[0];
      if (firstDate) {
        filterAndRender(firstDate);
        document.querySelector('.day-button').classList.add('active');
      }
    } catch (e) {
      document.body.innerHTML = '<p style="color:red; text-align:center; margin-top:2rem;">賽程載入失敗</p>';
      console.error(e);
    } finally {
      // 隱藏 loading
      const loadingEl = document.getElementById('loadingOverlay');
      if (loadingEl) loadingEl.style.display = 'none';
    }
  }

  function getUniqueDates() {
    const fmt = new Intl.DateTimeFormat("sv-SE", {
      timeZone: 'Asia/Taipei',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
    });
    return [...new Set(allRuns.map(run => fmt.format(run.start).replace(/-/g, '')))].sort();
  }

  function createDayButtons() {
    const container = document.getElementById('daySelector');
    container.innerHTML = '';
    const labelFmt = new Intl.DateTimeFormat("zh-TW", {
      timeZone: 'Asia/Taipei',
      month: '2-digit',
      day: '2-digit',
      weekday: 'short'
    });

    getUniqueDates().forEach(dateStr => {
      // yyyyMMdd
      const y = dateStr.slice(0,4);
      const m = dateStr.slice(4,6);
      const d = dateStr.slice(6,8);
      const localDate = new Date(`${y}-${m}-${d}T00:00:00`);

      const btn = document.createElement('button');
      btn.className = 'day-button';
      btn.textContent = labelFmt.format(localDate);
      btn.onclick = () => {
        document.querySelectorAll('.day-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filterAndRender(dateStr);
      };
      container.appendChild(btn);
    });
  }

  function filterAndRender(dateStr) {
    const scheduleList = document.getElementById('scheduleList');
    const thumbnailContainer = document.getElementById('thumbnailContainer');
    scheduleList.innerHTML = '';
    thumbnailContainer.innerHTML = '';

    if (embla) embla.destroy();
    if (thumbEmbla) thumbEmbla.destroy();

    const fmt = new Intl.DateTimeFormat("sv-SE", {
      timeZone: 'Asia/Taipei',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
    });

    const filtered = allRuns.filter(run =>
      fmt.format(run.start).replace(/-/g, '') === dateStr
    );

    if (filtered.length === 0) {
      scheduleList.innerHTML = '<div class="embla__slide" style="color:#f00; font-size:1.5rem; padding:1rem;">該日無賽程</div>';
      return;
    }

    filtered.forEach((item, i) => {
      const info = window.gameDB[item.game] || {};
      const details = (info.sgdq2025 && info.sgdq2025[item.category]) || [null, null];

      // 主輪播 slide
      const slide = document.createElement('div');
      slide.className = 'embla__slide';
      slide.innerHTML = `
        <div class="left-side">
          <img loading="lazy" class="game-boxart" src="${info.boxart || ''}" alt="${item.game}" />
        </div>
        <div class="right-side">
          <h2>${info.tw || info.en || item.game}</h2>
          <h3>${info.jp || ''}</h3>
          <h3>${info.en || ''}</h3>
          ${details[0] ? `<p class="category-tw">${details[0]}</p><p>${item.category}</p>` : `<p class="category-tw">${item.category}</p>`}
          <p><strong>預定開跑：</strong>${item.start.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei', hourCycle: 'h23', hour: '2-digit', minute: '2-digit' })}　<strong>預計長度：</strong>${item.estimate}</p>
          <p><strong>跑者：</strong>${item.runners}</p>
          ${details[1] ? `<p class="details">${details[1]}</p>` : ''}
        </div>
      `;
      scheduleList.appendChild(slide);

      // 縮圖 slide
      const thumbSlide = document.createElement('div');
      thumbSlide.className = 'embla__slide';
      const thumbImg = document.createElement('img');
      thumbImg.loading = 'lazy';
      thumbImg.className = 'thumbnail';
      thumbImg.src = info.boxart || '';
      thumbImg.alt = `${item.game} 縮圖`;
      thumbImg.dataset.index = i;
      thumbSlide.appendChild(thumbImg);
      thumbnailContainer.appendChild(thumbSlide);
    });

    // 初始化 Embla 主輪播
    embla = EmblaCarousel(document.getElementById('embla'), {
      loop: false,
      align: 'start',
      draggable: true,
      dragFree: true,
      speed: 10 },
      [ EmblaCarouselWheelGestures({ forceWheelAxis: 'y' }) ]
    );

    // 初始化 Embla 縮圖輪播
    thumbEmbla = EmblaCarousel(document.getElementById('thumbnailList'), {
      containScroll: 'trimSnaps',
      dragFree: true,
      axis: 'x' },
      [ EmblaCarouselWheelGestures({ forceWheelAxis: 'y' }) ]
    );

    function selectThumbnail(index) {
      document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
        thumb.classList.toggle('is-selected', i === index);
      });
    }

    // 主輪播切換時，同步選中縮圖並滾動縮圖輪播
    embla.on('select', () => {
  const index = embla.selectedScrollSnap();

  // 移除所有縮圖上的選擇狀態
  document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('is-selected'));

  // 加上當前的縮圖選擇狀態
  const selectedThumb = document.querySelector(`.thumbnail[data-index="${index}"]`);
  if (selectedThumb) {
    selectedThumb.classList.add('is-selected');
    
    // 捲動到畫面中央，而不是只靠滑入
    selectedThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
  }
    });

    // 縮圖點擊跳轉主輪播
    document.querySelectorAll('.thumbnail').forEach(thumb => {
      thumb.addEventListener('click', () => {
        const index = Number(thumb.dataset.index);
        embla.scrollTo(index);
      });
    });

    // 預設選中第一張
    embla.emit('select');
  }

  init();
</script>

</body>
</html>
