<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Awesome Games Done Quick 2026 時程表翻譯 ლ(╹◡╹ლ)</title>

<link href="https://fonts.googleapis.com/css2?family=Klee+One&display=swap" rel="stylesheet">
<!-- <link href="https://unpkg.com/embla-carousel/embla-carousel.css" rel="stylesheet" /> -->
<style>
  body {
    margin: 0;
    /* font-family: Arial, sans-serif; */
    /* Klee One, Kaisei Opti, Zen Kurenaido, Zen Maru Gothic */
    font-family: 'Klee One', monospace;
    color: white;

  user-select: none;

  text-shadow: black 0.2em 0.2em 0.3em;

  background-color: #222;
  background-image: linear-gradient(to right, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0.3)),
                    url(https://gamesdonequick.com/gdqsection.webp);
  background-repeat: no-repeat;
  background-size: cover;
  background-attachment: fixed;
  background-position: 70% 0%;

  display: flex;
  flex-direction: column;
  height: calc(var(--vh, 1vh) * 100); /* 視窗高度 */
  }
  .day-selector {
    display: flex;
    background: rgba(0, 0, 0, 0.2);
    overflow: hidden;
  }
  .day-button {
    flex: 1 1 auto; /* 平均分配寬度，自動壓縮 */
    background: rgba(0, 0, 0, 0.2);
    border: none;
    color: white;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    cursor: pointer;
    white-space: nowrap;
    transition: background-color 0.3s;

    text-shadow: black 0.2em 0.2em 0.3em;

    min-width: 0; /* 允許縮小，不超出容器 */
  }
  .day-button.active {
    /* background: #6441a5; */
    background: rgba(100, 65, 165, 0.85);
  }

  /* 主輪播 */
  #embla {
    overflow: hidden;
    width: 100%;
    flex-grow: 1; /* 撐滿剩餘空間 */
    height: auto; /* 取消 height: 80vh; 改成由 flex 控制 */
  }
  #embla .embla__container {
    display: flex;
    height: 100%;
  }
  #embla .embla__slide {
    min-width: 100%;
    box-sizing: border-box;
    display: flex;
    padding: 1rem;
    gap: 1rem;
    border-radius: 20px;
  }
  .left-side {
    width: 35%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
  }
  .right-side {
    /* align-items: center; */
    /* container-type: inline-size; */
    white-space: nowrap; /* 絕對不換行 */
  }
  .right-side h2 {
    margin: 0 0 10px;
    /* font-size: 7cqi; */
    font-size: 3.5rem;
    color: #FFF;
  }
  .game-boxart {
    /* width: 100%; */
    /* height: 70vh; */
    max-height: 70vh;
    max-width: 25vw;
    border-radius: 10px;
    /* object-fit: cover; */

/* align-items: center; */
/* justify-content: center; */
  }
  .right-side {
    width: 55%;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    color: #ccc;
    justify-content: center;
  }
  .right-side h3 {
    margin: 0;
    font-weight: normal;
    font-size: 2.25rem;
  }
  .category-tw {
    color: #9894F9;
    font-weight: bold;
    font-size: 1.75rem;
    margin: 0.25rem 0;
  }
  .details {
    color: #f08080;
    font-size: 1.5rem;
    margin: 0;
  }
  p {
    margin: 0.25rem 0;
    font-size: 1rem;
  }

  /* 縮圖輪播 */
  #thumbnailList {
    overflow: hidden;
    /* margin-top: 0.5rem; */
    background: rgba(0, 0, 0, 0.3);


bottom: 0;
  }
  #thumbnailList .embla__container {
    display: flex;
    padding: 0.5rem;
  }
  #thumbnailList .embla__slide {
    flex: 0 0 auto;
    margin-right: 0.5rem;
  }
  .thumbnail {
    width: 80px;
    height: 80px;
    border-radius: 6px;
    object-fit: cover;
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.3s;
  }
  .thumbnail.is-selected {
    border-color: #FFF;
  }

/* Loading 樣式 */
#loadingOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  z-index: 9999;
  text-shadow: black 0.1em 0.1em 0.2em;
}




.fade-out {
  opacity: 0;
  transition: opacity 0.6s ease;
}
.fade-in {
  opacity: 1;
  transition: opacity 0.6s ease;
}


/* 直立手機 */
@media (orientation: portrait) {

  #embla {
    /* zoom: 0.8; 相當於 100% 對應原本的 125% */
    /* transform: scale(0.8); */
  }

  .game-boxart {
    display: none !important;
  }

  .left-side {
    display: none !important;
  }

  .right-side {
    width: 100%;
    white-space: normal; /* 絕對不換行 */
  }


  .right-side h2 {
    font-size: 2rem;
  }

  .right-side h3 {
    font-size: 0.8rem;
  }

  .category-tw {
    font-size: 1.25rem;
  }

  .details {
    font-size: 1.1rem;
  }

  p {
    font-size: 0.8rem;
  }

  .day-button {
    font-size: 0.6rem;
  }

}

</style>
</head>
<body>

<div id="loadingOverlay">載入中，請稍候…</div>

<div class="day-selector" id="daySelector"></div>

<div id="embla" class="embla">
  <div class="embla__container" id="scheduleList"></div>
</div>

<div id="thumbnailList" class="embla">
  <div class="embla__container" id="thumbnailContainer"></div>
</div>

<script src="https://unpkg.com/embla-carousel/embla-carousel.umd.js"></script>
<script src="https://unpkg.com/embla-carousel-wheel-gestures/dist/embla-carousel-wheel-gestures.umd.js"></script>
<!-- <script src="renameDB.js"></script> -->
<script>
  // 顯示 loading
  const loadingEl = document.getElementById('loadingOverlay');
  if (loadingEl) loadingEl.style.display = 'flex';

  const EVENT_ID = 56;
  let allRuns = [];
  let embla, thumbEmbla;

  let gameDB = {};

async function init() {

  const loadingEl = document.getElementById('loadingOverlay');
  if (loadingEl) loadingEl.style.display = 'flex'; // 顯示載入畫面

  // gameDB init
  try {
    const gameDBRes = await fetch('./DB/AGDQ2026-game.json');
    gameDB = await gameDBRes.json();
    //console.log("✅ 資料載入成功", { gameDB });
    console.log("✅ gameDB 載入成功");
  } catch (e) {
    console.error("❌ gameDB 載入失敗：", e);
  }

  // Get Event JSON
  const EVENT_ID = 62;
  let json = null;

  try {

    // 嘗試取得舊版 API 資料
    try {
      const res = await fetch(`https://gamesdonequick.com/api/schedule/${EVENT_ID}`);
      json = await res.json();
      console.log("✅ 舊版 API 成功載入");
      json = { results: json.schedule || json.results }; // 修正舊版 API 資料來源
    } catch (err) {
      console.warn("❌ 舊版 API 失敗，嘗試使用新版 API", err);
    }

    // 嘗試取得新版 API 資料
    if (json == null) {
      try {
        const res = await fetch(`https://tracker.gamesdonequick.com/tracker/api/v2/events/${EVENT_ID}/runs`);
        json = await res.json();
        console.log("✅ 新版 API 成功載入");
      } catch (err) {
        console.warn("❌ 新版 API 失敗，嘗試使用本地備援資料", err);
      }
    }

    // 如果上面抓不到，就使用 local JS 備援
    if (json == null) {
      try {
        const res = await fetch('./DB/AGDQ2026-schedule.json');
        json = await res.json();
        console.log("✅ 使用本地備援資料成功");
      } catch (err) {
        console.error("❌ 備援資料也失敗", err);
      }
    }

    // 資料轉換：統一成你要用的格式
    allRuns = json.results
      .filter(r => r.type === 'speedrun' || r.name) // local JS 沒有 type 也接受
      .map(r => ({
        game: r.name,
        category: r.category,
        runners: Array.isArray(r.runners) ? r.runners.map(rr => rr.name).join(', ') : r.runners,
        start: new Date(r.starttime),
        estimate: r.run_time,
        console: r.console,
      }));

    createDayButtons(); // 建立上方的日期選單

    // =============== ✅ 自動偵測目前時間的節目 ===============

    const taipeiOffset = 8 * 60 * 60 * 1000; // 台北時區偏移（毫秒），目前沒用到但保留
    const now = Date.now(); // 取得當前時間的 UTC 毫秒數

    const currentRun = (() => {
      if (!allRuns.length) return null; // 沒有節目直接回 null

      // 先過濾出有開始時間的節目，並以開始時間正序排序
      const sorted = allRuns
        .filter(r => r.start)
        .sort((a, b) => a.start - b.start);

      // 取最後一個節目的開始時間（毫秒）
      const lastRunStart = sorted[sorted.length - 1].start.getTime();

      // 如果現在時間已超過最後節目開始時間一小時(3600000毫秒)，表示沒節目進行中
      if (now > lastRunStart + 3600000) return null;

      // 從最新的節目開始往前找，找到第一個開始時間小於等於現在的節目
      // 找不到的話回傳 null
      return [...sorted].reverse().find(r => now >= r.start.getTime()) || null;
    })();

    console.log("正在直播:");
    console.log(currentRun);

    // 預設顯示第一天（若沒有節目進行中）
    let dateStrToShow = getUniqueDates()[0];

    // 若有節目正在進行，顯示該節目的日期
    if (currentRun) {
      const fmt = new Intl.DateTimeFormat("sv-SE", {
        timeZone: 'Asia/Taipei',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
      });
      dateStrToShow = fmt.format(currentRun.start).replace(/-/g, '');
    }

    // 執行顯示指定日期的節目清單
    if (dateStrToShow) {
      await filterAndRender(dateStrToShow);

      // 自動將對應的日期按鈕標記為 active
      const dayButtons = document.querySelectorAll('.day-button');
      [...dayButtons].forEach(btn => {
        if (btn.textContent.replace(/\D/g, '') === dateStrToShow.slice(4)) {
          btn.classList.add('active');
        }
      });

      // 如果有進行中的項目，自動切換到對應的主輪播 slide
      if (currentRun) {
        const fmt = new Intl.DateTimeFormat("sv-SE", {
          timeZone: 'Asia/Taipei',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
        });
        const targetDay = fmt.format(currentRun.start).replace(/-/g, '');
        const filteredRuns = allRuns.filter(run =>
          fmt.format(run.start).replace(/-/g, '') === targetDay
        );
        const targetIndex = filteredRuns.findIndex(r => r === currentRun);
        if (typeof embla?.scrollTo === 'function') {
          setTimeout(() => {
            embla.scrollTo(targetIndex); // 自動切到那一場節目的頁面
          }, 300); // 稍微等 Embla 初始化
        }
      }
    }
    // =========================================================

  } catch (e) {
    // 整體流程錯誤，顯示錯誤訊息
    document.body.innerHTML = '<p style="color:red; text-align:center; margin-top:2rem;">賽程載入失敗</p>';
    console.error(e);
  } finally {
    // 不論成功與否，都移除 loading 畫面
    if (loadingEl) loadingEl.style.display = 'none';
  }
}


  function getUniqueDates() {
    const fmt = new Intl.DateTimeFormat("sv-SE", {
      timeZone: 'Asia/Taipei',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
    });
    return [...new Set(allRuns.map(run => fmt.format(run.start).replace(/-/g, '')))].sort();
  }

  function createDayButtons() {
    const container = document.getElementById('daySelector');
    container.innerHTML = '';
    const labelFmt = new Intl.DateTimeFormat("zh-TW", {
      timeZone: 'Asia/Taipei',
      month: '2-digit',
      day: '2-digit',
      weekday: 'short'
    });

    getUniqueDates().forEach(dateStr => {
      // yyyyMMdd
      const y = dateStr.slice(0,4);
      const m = dateStr.slice(4,6);
      const d = dateStr.slice(6,8);
      const localDate = new Date(`${y}-${m}-${d}T00:00:00`);

      const btn = document.createElement('button');
      btn.className = 'day-button';
      // btn.textContent = labelFmt.format(localDate);
      // let text = labelFmt.format(localDate).replace(/[（）]/g, ' ').trim(); // "07/07 週一"

if (window.innerHeight > window.innerWidth) {
  // 直式：07/07
  text = `${m}/${d}`;
} else {
  // 橫式：07/07 週一
  text = labelFmt.format(localDate).replace(/[（）]/g, ' ').trim();
}

      btn.textContent = text;
      btn.onclick = () => {
        document.querySelectorAll('.day-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filterAndRender(dateStr);
      };
      container.appendChild(btn);
    });
  }

  async function filterAndRender(dateStr) {
    const scheduleList = document.getElementById('scheduleList');
    const thumbnailContainer = document.getElementById('thumbnailContainer');


  const emblaEl = document.getElementById('embla');
  const thumbListEl = document.getElementById('thumbnailList');



  // 先移除 fade-in，確保動畫正確觸發
  emblaEl.classList.remove('fade-in');
  thumbListEl.classList.remove('fade-in');

  // 加 fade-out 淡出
  emblaEl.classList.add('fade-out');
  thumbListEl.classList.add('fade-out');

  // 強制重繪，觸發 transition
  emblaEl.offsetHeight;
  thumbListEl.offsetHeight;

  // 等 500ms (動畫時間) 再換內容
  await new Promise(resolve => setTimeout(resolve, 600));





    scheduleList.innerHTML = '';
    thumbnailContainer.innerHTML = '';

    if (embla) embla.destroy();
    if (thumbEmbla) thumbEmbla.destroy();

    const fmt = new Intl.DateTimeFormat("sv-SE", {
      timeZone: 'Asia/Taipei',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
    });

    const filtered = allRuns.filter(run =>
      fmt.format(run.start).replace(/-/g, '') === dateStr
    );

    if (filtered.length === 0) {
      scheduleList.innerHTML = '<div class="embla__slide" style="color:#f00; font-size:1.5rem; padding:1rem;">該日無賽程</div>';
      return;
    }

    filtered.forEach((item, i) => {

      // renameDB 已廢除
      // item.game = window.renameDB[item.game] || item.game;

      // console.log(item.game);
      const info = gameDB[item.game] || {};
      const details = (info.sgdq2025 && info.sgdq2025[item.category]) || [null, null];

      // 主輪播 slide
      const slide = document.createElement('div');
      slide.className = 'embla__slide';
      slide.innerHTML = `
        <div class="left-side">
          <img class="game-boxart" src="${info.boxart || 'https://static-cdn.jtvnw.net/ttv-static/404_boxart-600x800.jpg' || ''}" alt="${item.game}" />
        </div>
        <div class="right-side">
          <h2>${info.tw || info.jp || info.en || item.game}</h2>
          <h3>${info.jp || ''}</h3>
          <h3>${info.en || ''}</h3>
          ${details[0] ? `<p class="category-tw">${details[0]}</p><p>${item.category}</p>` : `<p class="category-tw">${item.category}</p>`}
          <p><strong>預定開跑：</strong>${item.start.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei', hourCycle: 'h23', hour: '2-digit', minute: '2-digit' })}　<strong>預計長度：</strong>${item.estimate}　<strong>主機平台：</strong>${item.console}</p>
          <p><strong>跑者：</strong>${item.runners}</p>
          ${details[1] ? `<p class="details">${details[1]}</p>` : ''}
        </div>
      `;
      scheduleList.appendChild(slide);

      // 縮圖 slide
      const thumbSlide = document.createElement('div');
      thumbSlide.className = 'embla__slide';
      const thumbImg = document.createElement('img');
      thumbImg.className = 'thumbnail';
      thumbImg.src = info.boxart || 'https://static-cdn.jtvnw.net/ttv-static/404_boxart-600x800.jpg' || '';
      thumbImg.alt = `${item.game} 縮圖`;
      thumbImg.dataset.index = i;
      thumbSlide.appendChild(thumbImg);
      thumbnailContainer.appendChild(thumbSlide);
    });

    // 初始化 Embla 主輪播
    embla = EmblaCarousel(document.getElementById('embla'), {
      loop: false,
      align: 'start',
      draggable: true,
      dragFree: true,
      speed: 10 },
      [ EmblaCarouselWheelGestures({ forceWheelAxis: 'y' }) ]
    );

    // 初始化 Embla 縮圖輪播
    thumbEmbla = EmblaCarousel(document.getElementById('thumbnailList'), {
      containScroll: 'trimSnaps',
      dragFree: true,
      axis: 'x' },
      [ EmblaCarouselWheelGestures({ forceWheelAxis: 'y' }) ]
    );

    function selectThumbnail(index) {
      document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
        thumb.classList.toggle('is-selected', i === index);
      });
    }

    // 主輪播切換時，同步選中縮圖並滾動縮圖輪播
    embla.on('select', () => {
  const index = embla.selectedScrollSnap();

  // 移除所有縮圖上的選擇狀態
  document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('is-selected'));

  // 加上當前的縮圖選擇狀態
  const selectedThumb = document.querySelector(`.thumbnail[data-index="${index}"]`);
  if (selectedThumb) {
    selectedThumb.classList.add('is-selected');
    
    // 捲動到畫面中央，而不是只靠滑入
    selectedThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
  }
    });

    // 縮圖點擊跳轉主輪播
    document.querySelectorAll('.thumbnail').forEach(thumb => {
      thumb.addEventListener('click', () => {
        const index = Number(thumb.dataset.index);
        embla.scrollTo(index);
      });
    });



  // 淡入
  emblaEl.classList.remove('fade-out');
  emblaEl.classList.add('fade-in');
  thumbListEl.classList.remove('fade-out');
  thumbListEl.classList.add('fade-in');





    // 預設選中第一張
    embla.emit('select');
  }

  init();


window.addEventListener('resize', () => {
  const currentActive = document.querySelector('.day-button.active');
  const selectedDateStr = currentActive?.textContent?.replace(/\D/g, '');

  createDayButtons();

  // 保留使用者目前選擇的日期按鈕
  const buttons = document.querySelectorAll('.day-button');
  const firstButton = buttons[0];
  if (selectedDateStr && buttons.length > 0) {
    const match = [...buttons].find(btn => btn.textContent.replace(/\D/g, '') === selectedDateStr);
    if (match) {
      match.classList.add('active');
    } else {
      firstButton?.classList.add('active');
    }
  }

});


function setRealVH() {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
setRealVH();
window.addEventListener('resize', setRealVH);

</script>

</body>
</html>
